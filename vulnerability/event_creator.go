package vulnerability

import (
	db_types "github.com/aquasecurity/trivy-db/pkg/types"
	trivy_types "github.com/aquasecurity/trivy/pkg/types"
	"github.com/elastic/beats/v7/libbeat/beat"
	"github.com/elastic/cloudbeat/transformer"
	"github.com/elastic/cloudbeat/version"
	"github.com/elastic/elastic-agent-libs/mapstr"
	"strings"
	"time"
)

type Finding struct {
	Target string                  `json:"target,omitempty"`
	Type   string                  `json:"type,omitempty"`
	Class  trivy_types.ResultClass `json:"class,omitempty"`
	Vul    Vulnerability           `json:"vulnerability,omitempty"`
}

type Vulnerability struct {
	Cvss           db_types.VendorCVSS  `json:"cvss,omitempty"`
	DataSource     *db_types.DataSource `json:"data_source,omitempty"`
	Scanner        Scanner              `json:"scanner,omitempty"`
	Score          Score                `json:"score,omitempty"`
	Package        Package              `json:"package,omitempty"`
	Cwe            []string             `json:"cwe,omitempty"`
	ID             string               `json:"id,omitempty"`
	Title          string               `json:"title,omitempty"`
	Enumeration    string               `json:"enumeration,omitempty"`
	Reference      string               `json:"reference,omitempty"`
	Description    string               `json:"description,omitempty"`
	Severity       string               `json:"severity,omitempty"`
	Classification string               `json:"classification,omitempty"`
}

type Package struct {
	FixedVersion string `json:"fixed_version,omitempty"`
	Version      string `json:"version,omitempty"`
	Name         string `json:"name,omitempty"`
}

type Scanner struct {
	Version string `json:"version,omitempty"`
	Vendor  string `json:"vendor,omitempty"`
}

type Score struct {
	Impact  float64 `json:"impact,omitempty"`
	Base    float64 `json:"base,omitempty"`
	Version string  `json:"version,omitempty"`
}

const (
	vulScannerVendor      = "Trivy"
	vulScoreSystemClass   = "CVSS"
	vulScoreSource        = "nvd"
	vulScoreSourceVersion = "3.0"
	vulEcsCategory        = "vulnerability"
)

func createVulnerabilityEvent(target string, class trivy_types.ResultClass, vulType string, vul trivy_types.DetectedVulnerability, timestamp time.Time) beat.Event {
	cvssScore := getCVSSScore(vul, vulScoreSource)
	return beat.Event{
		Timestamp: timestamp,
		Fields: mapstr.M{
			"cloudbeat": version.CloudbeatVersion(),
			"event":     transformer.BuildECSEvent(time.Now().Unix(), timestamp, []string{vulEcsCategory}),
			"finding": Finding{
				Target: target,
				Class:  class,
				Type:   vulType,
				Vul: Vulnerability{
					Cvss:       vul.CVSS,
					DataSource: vul.DataSource,
					Scanner: Scanner{
						Version: "",
						Vendor:  vulScannerVendor,
					},
					Score: Score{
						Impact:  cvssScore,
						Base:    cvssScore,
						Version: vulScoreSourceVersion,
					},
					Package: Package{
						FixedVersion: vul.FixedVersion,
						Name:         vul.PkgName,
						Version:      vul.InstalledVersion,
					},
					Cwe:            vul.CweIDs,
					ID:             vul.VulnerabilityID,
					Title:          vul.Title,
					Enumeration:    getIdentifierType(vul.VulnerabilityID),
					Reference:      vul.PrimaryURL,
					Description:    vul.Description,
					Severity:       vul.Severity,
					Classification: vulScoreSystemClass,
				},
			},
		},
	}
}

func getIdentifierType(id string) string {
	return strings.Split(id, "-")[0]
}

func getCVSSScore(vul trivy_types.DetectedVulnerability, source db_types.SourceID) float64 {
	if cvss, ok := vul.CVSS[source]; ok {
		return cvss.V3Score
	}

	return 0
}
